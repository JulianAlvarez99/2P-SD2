<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clima Distribuido | Live Monitor</title>
    <!-- Importamos fuente moderna 'Poppins' -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Vinculamos la hoja de estilos externa -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- Overlay de Bloqueo Moderno -->
<div id="overlay-blocked">
    <div class="loader-ring"></div>
    <h2 style="margin-bottom: 10px; font-weight: 600;">Servidor Saturado</h2>
    <p style="opacity: 0.8; margin-bottom: 20px;">Estamos experimentando alta demanda.</p>
    <div style="background: rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 20px; font-size: 0.85rem;">
        Reintentando conexi√≥n autom√°tica en <span id="retry-counter">5</span>s...
    </div>
</div>

<div class="container">
    <div class="header">
        <h1>Clima Distribuido</h1>
        <div class="user-badge">
            <div class="status-dot"></div>
            <span id="countDisplay">--</span> online
        </div>
    </div>

    <div class="controls-grid">
        <div class="input-group">
            <label for="provincia">Provincia</label>
            <select id="provincia">
                <option value="">Cargando provincias...</option>
            </select>
        </div>

        <div class="input-group">
            <label for="localidad">Localidad (Opcional)</label>
            <select id="localidad" disabled>
                <option value="">Seleccione provincia primero</option>
            </select>
        </div>
    </div>

    <button id="btnConsultar">
        <span style="margin-right: 8px;">üîç</span> Consultar Tiempo Real
    </button>

    <div id="resultado">
        <!-- Aqu√≠ se inyecta la tabla -->
    </div>
</div>

<script>
    // --- L√ìGICA DE INTERFAZ Y WEBSOCKET ---

    const overlay = document.getElementById('overlay-blocked');
    const countDisplay = document.getElementById('countDisplay');
    const statusDot = document.querySelector('.status-dot');
    const retryCounter = document.getElementById('retry-counter');

    let socket = null;
    let reconnectTimer = null;
    let countdownInterval = null;

    function updateStatus(color) {
        statusDot.style.backgroundColor = color;
        statusDot.style.boxShadow = `0 0 8px ${color}`;
    }

    function connectWebSocket() {
        if (socket) {
            socket.onclose = null;
            socket.close();
        }
        clearReconnectionTimers();

        // Detectar protocolo y path autom√°ticamente
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const path = window.location.pathname.substring(0, window.location.pathname.indexOf('/', 1));
        const wsUrl = `${protocol}//${window.location.host}${path}/ws/contador`;

        console.log("Conectando WS:", wsUrl);
        socket = new WebSocket(wsUrl);

        socket.onopen = function() {
            console.log(">>> Conexi√≥n establecida");
            overlay.style.display = 'none';
            updateStatus('#48bb78'); // Verde
        };

        socket.onmessage = function(event) {
            const msg = event.data;
            if (msg === "BLOCKED") {
                triggerBlockScreen();
            } else if (msg.startsWith("COUNT:")) {
                countDisplay.textContent = msg.split(":")[1];
            }
        };

        socket.onclose = function(event) {
            updateStatus('#f56565'); // Rojo
            console.warn("Socket cerrado:", event.code);
            triggerBlockScreen();
        };

        socket.onerror = function(err) {
            console.error("Error socket:", err);
            socket.close();
        };
    }

    function triggerBlockScreen() {
        overlay.style.display = 'flex';
        updateStatus('#f56565');

        if (!reconnectTimer) {
            let secondsLeft = 5;
            retryCounter.textContent = secondsLeft;

            // Cuenta regresiva visual
            countdownInterval = setInterval(() => {
                secondsLeft--;
                retryCounter.textContent = secondsLeft;
                if (secondsLeft <= 0) clearInterval(countdownInterval);
            }, 1000);

            reconnectTimer = setTimeout(() => {
                reconnectTimer = null;
                connectWebSocket();
            }, 5000);
        }
    }

    function clearReconnectionTimers() {
        if (reconnectTimer) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
        }
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
    }

    // --- L√ìGICA DE NEGOCIO (IGUAL AL ORIGINAL) ---

    const selProvincia = document.getElementById('provincia');
    const selLocalidad = document.getElementById('localidad');
    const btnConsultar = document.getElementById('btnConsultar');
    const divResultado = document.getElementById('resultado');

    document.addEventListener('DOMContentLoaded', () => {
        connectWebSocket(); // Iniciar WS

        fetch('api/geo?type=provincias')
            .then(res => res.json())
            .then(data => populateSelect(selProvincia, data.provincias, 'Seleccione una provincia'))
            .catch(e => {
                console.error("Error API GeoRef", e);
                selProvincia.innerHTML = '<option>Error al cargar API</option>';
            });
    });

    selProvincia.addEventListener('change', () => {
        const prov = selProvincia.value;
        selLocalidad.innerHTML = '<option>Cargando...</option>';
        selLocalidad.disabled = true;

        if(prov) {
            fetch(`api/geo?type=localidades&prov=${encodeURIComponent(prov)}`)
                .then(res => res.json())
                .then(d => {
                    populateSelect(selLocalidad, d.localidades, 'Todas las localidades (Opcional)');
                    selLocalidad.disabled = false;
                });
        } else {
            selLocalidad.innerHTML = '<option value="">Seleccione provincia primero</option>';
        }
    });

    btnConsultar.addEventListener('click', () => {
        const prov = selProvincia.value;
        const loc = selLocalidad.value;

        if(!prov) {
            // Animaci√≥n de "shake" si falta input
            selProvincia.style.borderColor = '#f56565';
            setTimeout(() => selProvincia.style.borderColor = '#e2e8f0', 500);
            return;
        }

        // Feedback de carga en el bot√≥n
        const originalText = btnConsultar.innerHTML;
        btnConsultar.innerHTML = '‚è≥ Buscando...';
        btnConsultar.disabled = true;
        divResultado.style.opacity = '0.5';

        let url = `api/weather-table?provincia=${encodeURIComponent(prov)}`;
        if(loc) url += `&localidad=${encodeURIComponent(loc)}`;

        fetch(url)
            .then(r => r.text())
            .then(html => {
                divResultado.innerHTML = html;
                divResultado.style.opacity = '1';
                btnConsultar.innerHTML = originalText;
                btnConsultar.disabled = false;
            })
            .catch(err => {
                divResultado.innerHTML = `<div style="color:var(--error-color); text-align:center; margin-top:20px;">Error de conexi√≥n con el Backend</div>`;
                btnConsultar.innerHTML = originalText;
                btnConsultar.disabled = false;
            });
    });

    function populateSelect(sel, items, def) {
        sel.innerHTML = `<option value="">${def}</option>`;
        items.forEach(i => {
            let o = document.createElement('option');
            o.value = i.nombre;
            o.textContent = i.nombre;
            sel.appendChild(o);
        });
    }

</script>

</body>
</html>