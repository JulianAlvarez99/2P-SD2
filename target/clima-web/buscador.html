<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clima Distribuido | Live Monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- Overlay de Bloqueo / Cola de Espera -->
<div id="overlay-blocked">
    <div class="loader-ring"></div>
    <h2 style="margin-bottom: 10px; font-weight: 600;">Sala de Espera</h2>
    <p style="opacity: 0.8; margin-bottom: 20px;">El servidor est√° lleno. Est√°s en fila.</p>

    <!-- Indicador de Posici√≥n -->
    <div id="queue-status" style="background: rgba(255,255,255,0.15); padding: 15px 30px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.3);">
        <span style="display:block; font-size: 0.8rem; text-transform:uppercase; letter-spacing: 1px;">Tu Posici√≥n</span>
        <span id="queue-pos" style="font-size: 2.5rem; font-weight: 700; color: #f6ad55;">--</span>
    </div>

    <p style="margin-top: 20px; font-size: 0.8rem; color: #cbd5e0;">No cierres esta pesta√±a o perder√°s tu lugar.</p>
</div>

<div class="container">
    <div class="header">
        <h1>Clima Distribuido</h1>
        <div class="user-badge">
            <div class="status-dot"></div>
            <span id="countDisplay">--</span> online
        </div>
    </div>

    <div class="controls-grid">
        <div class="input-group">
            <label for="provincia">Provincia</label>
            <select id="provincia">
                <option value="">Cargando provincias...</option>
            </select>
        </div>

        <div class="input-group">
            <label for="localidad">Localidad (Opcional)</label>
            <select id="localidad" disabled>
                <option value="">Seleccione provincia primero</option>
            </select>
        </div>
    </div>

    <button id="btnConsultar">
        <span style="margin-right: 8px;">üîç</span> Consultar Tiempo Real
    </button>

    <div id="resultado"></div>
</div>

<script>
    // --- L√ìGICA DE INTERFAZ Y WEBSOCKET (COLA FIFO) ---

    const overlay = document.getElementById('overlay-blocked');
    const countDisplay = document.getElementById('countDisplay');
    const queuePosDisplay = document.getElementById('queue-pos');
    const statusDot = document.querySelector('.status-dot');

    let socket = null;

    function updateStatus(color) {
        statusDot.style.backgroundColor = color;
        statusDot.style.boxShadow = `0 0 8px ${color}`;
    }

    function connectWebSocket() {
        if (socket) { socket.close(); }

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const path = window.location.pathname.substring(0, window.location.pathname.indexOf('/', 1));
        const wsUrl = `${protocol}//${window.location.host}${path}/ws/contador`;

        console.log("Conectando WS:", wsUrl);
        socket = new WebSocket(wsUrl);

        socket.onopen = function() {
            console.log(">>> Conexi√≥n establecida con Socket");
            // Nota: No ocultamos el overlay aqu√≠ todav√≠a. Esperamos instrucci√≥n del servidor.
        };

        socket.onmessage = function(event) {
            const msg = event.data;
            console.log("Mensaje Server:", msg);

            if (msg === "ACCEPTED") {
                // ¬°Entramos!
                overlay.style.display = 'none';
                updateStatus('#48bb78'); // Verde
            }
            else if (msg.startsWith("WAITING:")) {
                // En cola
                const pos = msg.split(":")[1];
                showQueueScreen(pos);
            }
            else if (msg.startsWith("COUNT:")) {
                // Info general
                countDisplay.textContent = msg.split(":")[1];
            }
        };

        socket.onclose = function(event) {
            updateStatus('#f56565'); // Rojo
            console.warn("Socket desconectado.");
            // Si se cae la conexi√≥n, mostramos error gen√©rico en el overlay
            queuePosDisplay.innerHTML = "<span style='font-size:1rem'>Desconectado</span>";
            overlay.style.display = 'flex';
        };
    }

    function showQueueScreen(position) {
        overlay.style.display = 'flex';
        queuePosDisplay.textContent = position;
        updateStatus('#ecc94b'); // Amarillo (Esperando)
    }

    // --- L√ìGICA DE NEGOCIO (Igual que antes) ---

    const selProvincia = document.getElementById('provincia');
    const selLocalidad = document.getElementById('localidad');
    const btnConsultar = document.getElementById('btnConsultar');
    const divResultado = document.getElementById('resultado');

    document.addEventListener('DOMContentLoaded', () => {
        connectWebSocket(); // Iniciar conexi√≥n persistente

        fetch('api/geo?type=provincias')
            .then(res => res.json())
            .then(data => populateSelect(selProvincia, data.provincias, 'Seleccione una provincia'))
            .catch(e => {
                console.error("Error API GeoRef", e);
                selProvincia.innerHTML = '<option>Error al cargar API</option>';
            });
    });

    selProvincia.addEventListener('change', () => {
        const prov = selProvincia.value;
        selLocalidad.innerHTML = '<option>Cargando...</option>';
        selLocalidad.disabled = true;

        if(prov) {
            fetch(`api/geo?type=localidades&prov=${encodeURIComponent(prov)}`)
                .then(res => res.json())
                .then(d => {
                    populateSelect(selLocalidad, d.localidades, 'Todas las localidades (Opcional)');
                    selLocalidad.disabled = false;
                });
        } else {
            selLocalidad.innerHTML = '<option value="">Seleccione provincia primero</option>';
        }
    });

    btnConsultar.addEventListener('click', () => {
        const prov = selProvincia.value;
        const loc = selLocalidad.value;

        if(!prov) {
            selProvincia.style.borderColor = '#f56565';
            setTimeout(() => selProvincia.style.borderColor = '#e2e8f0', 500);
            return;
        }

        const originalText = btnConsultar.innerHTML;
        btnConsultar.innerHTML = '‚è≥ Buscando...';
        btnConsultar.disabled = true;
        divResultado.style.opacity = '0.5';

        let url = `api/weather-table?provincia=${encodeURIComponent(prov)}`;
        if(loc) url += `&localidad=${encodeURIComponent(loc)}`;

        fetch(url)
            .then(r => r.text())
            .then(html => {
                divResultado.innerHTML = html;
                divResultado.style.opacity = '1';
                btnConsultar.innerHTML = originalText;
                btnConsultar.disabled = false;
            })
            .catch(err => {
                divResultado.innerHTML = `<div style="color:var(--error-color); text-align:center; margin-top:20px;">Error de conexi√≥n con el Backend</div>`;
                btnConsultar.innerHTML = originalText;
                btnConsultar.disabled = false;
            });
    });

    function populateSelect(sel, items, def) {
        sel.innerHTML = `<option value="">${def}</option>`;
        items.forEach(i => {
            let o = document.createElement('option');
            o.value = i.nombre;
            o.textContent = i.nombre;
            sel.appendChild(o);
        });
    }
</script>

</body>
</html>